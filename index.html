/*
File: index.html
Description: Entry point, loads CSS, dependency scripts via CDN, and main module.
*/
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COS Scheduling App</title>
  <link rel="stylesheet" href="css/style.css" />
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.4/index.global.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.4/index.global.min.css" rel="stylesheet" />
</head>
<body>
  <!-- Upload Control -->
  <input type="file" id="schedule-upload" accept=".csv" />
  <!-- Containers for visualizations -->
  <div id="heatmap-container"></div>
  <canvas id="linechart-canvas"></canvas>
  <div id="calendar"></div>

  <!-- Dependencies via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.4/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.4/index.global.min.js"></script>
  <!-- External Mappings -->
  <script src="js/cal_getc_mapping.js"></script>
  <!-- Main application module -->
  <script type="module" src="js/main.js"></script>
</body>
</html>

/*
File: js/parser.js
Description: Parses CSV files, filters data, and returns structured schedule entries using global Papa.
*/
export function parseCSVFile(file) {
  return new Promise((resolve, reject) => {
    // Use global Papa
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const data = results.data
          .filter(r => r['ROOM'] && !['', 'N/A', 'LIVE'].includes((r['ROOM']||'').toUpperCase()))
          .filter(r => !(r['BUILDING'] && r['BUILDING'].toUpperCase() === 'ONLINE'))
          .map(r => ({
            Building: r['BUILDING'] || '',
            Room: r['ROOM'] || '',
            Days: (r['DAYS'] || '').split('').map(d => ({'M':'Monday','T':'Tuesday','W':'Wednesday','R':'Thursday','F':'Friday','U':'Sunday','S':'Saturday'})[d]||d),
            Start_Time: r['Time']?.split('-')[0].trim() || '',
            End_Time: r['Time']?.split('-')[1].trim() || '',
            Start_Date: r['Start_Date'] || '',
            End_Date: r['End_Date'] || '',
            Instructor: r['Instructor'] || '',
            Campus: r['CAMPUS'] || ''
          }));
        resolve(data);
      },
      error: (err) => reject(err)
    });
  });
}

/*
File: js/timeUtils.js
Description: Utility functions for time parsing and range calculation.
*/
export function parseHour(t) {
  if (!t) return null;
  const m = t.trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)?$/i);
  if (!m) return null;
  let h = parseInt(m[1], 10), min = parseInt(m[2], 10);
  const ampm = m[3]?.toUpperCase();
  if (ampm === 'AM' && h === 12) h = 0;
  if (ampm === 'PM' && h !== 12) h += 12;
  return h + min / 60;
}

export function getTimeRangeFromData(data) {
  let min = 24, max = 0;
  data.forEach(r => {
    const s = parseHour(r.Start_Time);
    const e = parseHour(r.End_Time);
    if (s != null) min = Math.min(min, s);
    if (e != null) max = Math.max(max, e);
  });
  return { start: min, end: max };
}

/*
File: js/heatmap.js
Description: Renders a weekly heatmap of room usage based on schedule data.
*/
import { getTimeRangeFromData, parseHour } from './timeUtils.js';

export function renderHeatmap(data) {
  const container = document.getElementById('heatmap-container');
  container.innerHTML = '';

  const { start, end } = getTimeRangeFromData(data);
  // Build heatmap grid based on start/end and room occupancy
  // [Implementation here]
  
  // Append generated heatmap element
  container.appendChild(hmTable);
}

/*
File: js/lineChart.js
Description: Renders a line chart of course counts over time using global Chart.
*/
export function renderLineChart(data) {
  const ctx = document.getElementById('linechart-canvas').getContext('2d');
  // Process data into datasets and labels
  // [Implementation here]

  new Chart(ctx, {
    type: 'line',
    data: {/* datasets & labels */},
    options: {/* chart options */}
  });
}

/*
File: js/calendar.js
Description: Initializes FullCalendar with events derived from schedule data.
*/
export function initCalendar(data) {
  const calendarEl = document.getElementById('calendar');
  if (window.FullCalendar) {
    const events = data.flatMap(r => r.Days.map(day => ({
      title: `${r.Building}-${r.Room}`,
      startRecur: r.Start_Date,
      endRecur: r.End_Date,
      daysOfWeek: [ ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].indexOf(day) ],
      startTime: r.Start_Time,
      endTime: r.End_Time
    })));

    new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      weekNumbers: true,
      events
    }).render();
  }
}

/*
File: js/main.js
Description: Application entry point, wires up file upload and rendering modules.
*/
import { parseCSVFile } from './parser.js';
import { renderHeatmap } from './heatmap.js';
import { renderLineChart } from './lineChart.js';
import { initCalendar } from './calendar.js';

const uploadInput = document.getElementById('schedule-upload');
uploadInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const data = await parseCSVFile(file);
    renderHeatmap(data);
    renderLineChart(data);
    initCalendar(data);
  } catch (err) {
    console.error('Error parsing schedule:', err);
  }
});
