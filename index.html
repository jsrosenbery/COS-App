// At the top, after hmChoices, add:
let campusChoices;
let lineCourseChoices, lineCampusChoices;
let lineChartInstance;

const hmDays = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const hmHours = Array.from({length:17}, (_, i) => i + 6); // 6–22

// After your initHeatmap function, add:
function initCampusChoices() {
  campusChoices = new Choices('#campusSelect', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Filter by campus',
  });
}

// For the line chart controls:
function initLineChartChoices() {
  lineCourseChoices = new Choices('#lineCourseSelect', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Filter by discipline/course',
  });
  lineCampusChoices = new Choices('#lineCampusSelect', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Filter by campus',
  });
}

// Update feedHeatmapTool to also populate campus choices:
function feedHeatmapTool(dataArray) {
  hmRaw = dataArray.map(r => {
    const parts = (r.Subject_Course || '').trim().split(/\s+/);
    const key = parts.length >=2 ? (parts[0] + ' ' + parts[1]) : (r.Subject_Course || '').trim();
    return {
      key,
      Building: r.Building || '',
      Room: r.Room || '',
      Days: r.Days || [],
      Start_Time: r.Start_Time || '',
      End_Time: r.End_Time || '',
      Campus: r.Campus || '', // Add campus
    };
  });
  const uniqueKeys = Array.from(new Set(hmRaw.map(r => r.key).filter(k => k))).sort();
  const items = uniqueKeys.map(k => ({ value: k, label: k }));
  if (hmChoices) {
    hmChoices.setChoices(items, 'value', 'label', true);
  }
  // Populate campus multi-select
  const campuses = Array.from(new Set(hmRaw.map(r => r.Campus).filter(Boolean))).sort();
  const campusItems = campuses.map(c => ({ value: c, label: c }));
  if (campusChoices) {
    campusChoices.setChoices(campusItems, 'value', 'label', true);
  }
  // Also initialize line chart choices
  if (lineCourseChoices) {
    lineCourseChoices.setChoices(items, 'value', 'label', true);
  }
  if (lineCampusChoices) {
    lineCampusChoices.setChoices(campusItems, 'value', 'label', true);
  }
  updateAllHeatmap();
  renderLineChart(); // New: render line chart on data feed
}

// UpdateAllHeatmap: add campus filtering
function updateAllHeatmap() {
  const selected = hmChoices.getValue(true);
  const selectedCampuses = campusChoices ? campusChoices.getValue(true) : [];
  const rows = hmRaw.filter(r => {
    if(selected.length && !selected.includes(r.key)) return false;
    if(selectedCampuses.length && !selectedCampuses.includes(r.Campus)) return false;
    if(!r.Building || !r.Room) return false;
    const b = r.Building.toUpperCase(), ro = r.Room.toUpperCase();
    if(b==='N/A'||ro==='N/A'||b==='ONLINE') return false;
    return true;
  }).map(r => [r.key, r.Building, r.Room, r.Days.join(','), r.Start_Time + '-' + r.End_Time]);
  hmTable.clear().rows.add(rows).draw();
}

// Add renderLineChart function
function renderLineChart() {
  // Get selected filters
  const selectedCourses = lineCourseChoices ? lineCourseChoices.getValue(true) : [];
  const selectedCampuses = lineCampusChoices ? lineCampusChoices.getValue(true) : [];

  // Filter data
  const filtered = hmRaw.filter(r => {
    if(selectedCourses.length && !selectedCourses.includes(r.key)) return false;
    if(selectedCampuses.length && !selectedCampuses.includes(r.Campus)) return false;
    if (!r.Days.length || !r.Start_Time || !r.End_Time) return false;
    return true;
  });

  // Prepare datasets: plot each course instance as a horizontal "line" for its duration on each day
  const datasets = [];
  const colorMap = {};
  let colorIdx = 0;
  const getColor = (key) => {
    if (!colorMap[key]) {
      // Generate unique pastel color
      colorMap[key] = `hsl(${(colorIdx*41)%360},70%,60%)`;
      colorIdx++;
    }
    return colorMap[key];
  };

  hmDays.forEach((day, i) => {
    filtered.forEach(rec => {
      if (rec.Days.includes(day)) {
        const startParts = rec.Start_Time.split(':').map(Number);
        const endParts = rec.End_Time.split(':').map(Number);
        // Chart.js expects times as floats, e.g., 9.5 for 9:30
        const startFloat = startParts[0]+(startParts[1]/60);
        const endFloat = endParts[0]+(endParts[1]/60);

        datasets.push({
          label: `${rec.key} — ${rec.Campus} (${day})`,
          data: [
            { x: startFloat, y: day },
            { x: endFloat, y: day }
          ],
          borderColor: getColor(rec.key + rec.Campus),
          backgroundColor: getColor(rec.key + rec.Campus),
          fill: false,
          showLine: true,
          pointRadius: 0,
          borderWidth: 6,
        });
      }
    });
  });

  // Draw chart
  const ctx = document.getElementById('lineChartCanvas').getContext('2d');
  // Destroy previous chart if any
  if (lineChartInstance) {
    lineChartInstance.destroy();
  }
  lineChartInstance = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          type: 'linear',
          min: 6,
          max: 22,
          title: { display: true, text: 'Hour of Day' },
          ticks: {
            callback: function(val) {
              // Format as 12hr time
              const h = Math.floor(val);
              const m = Math.round((val-Math.floor(val))*60);
              const ap = h < 12 ? 'AM':'PM';
              const hr = ((h+11)%12)+1;
              return (m ? `${hr}:${('0'+m).slice(-2)}` : `${hr}`) + ap;
            },
            stepSize: 1
          }
        },
        y: {
          type: 'category',
          labels: hmDays,
          title: { display: true, text: 'Day' }
        }
      },
      elements: {
        line: { borderCapStyle: 'round' }
      },
      interaction: { mode: 'nearest', axis: 'xy', intersect: false },
      animation: false,
      maintainAspectRatio: false,
    }
  });
}

// Show/hide the new chart tool and wire up controls
document.addEventListener('DOMContentLoaded', () => {
  // ... existing DOMContentLoaded code ...

  initCampusChoices();
  initLineChartChoices();

  // When view changes, toggle visibility
  document.getElementById('viewSelect').addEventListener('change', function(){
    document.getElementById('heatmap-tool').style.display = (this.value === 'heatmap') ? 'block' : 'none';
    document.getElementById('schedule-container').style.display = (this.value === 'calendar') ? '' : 'none';
    document.getElementById('availability-ui').style.display = (this.value === 'calendar') ? '' : 'none';
    document.getElementById('room-filter').style.display = (this.value === 'calendar') ? '' : 'none';
    document.getElementById('upload-container').style.display = (this.value === 'calendar') ? '' : 'none';
    document.getElementById('upload-timestamp').style.display = (this.value === 'calendar') ? '' : 'none';
    document.getElementById('linechart-tool').style.display = (this.value === 'linechart') ? 'block' : 'none';
    if (this.value === 'linechart') {
      renderLineChart();
    }
  });

  // Filter events for line chart controls
  document.getElementById('lineCourseSelect').addEventListener('change', renderLineChart);
  document.getElementById('lineCampusSelect').addEventListener('change', renderLineChart);
});

// On data load, feedHeatmapTool also calls renderLineChart

// (rest of your code stays the same)
